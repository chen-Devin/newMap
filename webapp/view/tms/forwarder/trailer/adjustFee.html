<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>调整费用 - TMS</title>
    <link rel="stylesheet" href="/view/frame/layui/css/layui.css" media="all">
    <link rel="stylesheet" href="/view/frame/static/css/global.css?v=1.0">
    <link rel="stylesheet" href="/view/tms/static/css/add.css?v=1.0">
    <style>
        .layui-form-item .layui-form-label {
            width: 60px;
        }
        
        .layui-form-item .layui-input-block {
            margin-left: 90px;
        }
        
        .button-bar {
            margin: 5px 0 30px;
        }
        
        .layui-table {
            margin-bottom: 5px;
        }
        
        .layui-table th {
            font-weight: bold;
        }
        
        .layui-table th,
        .layui-table td {
            text-align: center;
        }
        
        .layui-table th.b,
        .layui-table td.b {
            border-right: #bbb 2px solid;
        }
        
        .layui-table td.h {
            background: #efefef;
        }
        
        .layui-table td.amount {
            padding: 0;
        }
        
        .layui-table td.amount input {
            display: none;
            width: 100%;
            height: 30px;
            background: #fdfcd2;
            border: 0;
        }
        
        .space-line {
            height: 13px;
            line-height: 13px;
            text-align: right;
            font-size: 12px;
            margin-bottom: 5px;
            overflow: hidden;
        }
        
        .space-line a {
            color: #1E9FFF;
        }
        
        .tr-hide {
            display: none;
        }
    </style>
</head>

<body>
    <form class="layui-form" autocomplete="off" style="min-width:800px;">
        <fieldset class="layui-elem-field layui-field-title" style="margin-top:20px;">
            <legend>主要信息</legend>
        </fieldset>
        <table class="layui-table main-ark">
            <thead>
                <tr>
                    <th>作业单号</th>
                    <th>客户名称</th>
                    <th>装卸地点</th>
                    <th>箱型</th>
                    <th>S/O</th>
                    <th>箱号</th>
                    <th>运费限价</th>
                    <th>拖车 - 车架</th>
                    <th>司机</th>
                    <th>司机手机</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <div id="receiveFreight">
            <fieldset class="layui-elem-field layui-field-title" style="margin-top:20px;">
                <legend>应收费用</legend>
            </fieldset>
            <table class="layui-table" lay-size="sm">
                <colgroup>
                    <col width="80">
                    <col width="100">
                    <col width="100">
                    <col width="100">
                    <col width="80">
                    <col width="100">
                    <col width="100">
                    <col width="100">
                    <col width="80">
                    <col width="100">
                    <col width="100">
                    <col width="100">
                    <col width="80">
                    <col width="100">
                    <col width="100">
                    <col width="100">
                </colgroup>
                <thead>
                    <tr>
                        <th>序号</th>
                        <th>费用</th>
                        <th>金额</th>
                        <th class="b">开发票</th>
                        <th>序号</th>
                        <th>费用</th>
                        <th>金额</th>
                        <th class="b">开发票</th>
                        <th>序号</th>
                        <th>费用</th>
                        <th>金额</th>
                        <th class="b">开发票</th>
                        <th>序号</th>
                        <th>费用</th>
                        <th>金额</th>
                        <th>开发票</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <div class="space-line"><a><i class="layui-icon">&#xe61a;</i>展开更多费用</a></div>
            <div class="layui-row">
                <div class="layui-col-sm3 layui-col-xs3">
                    <div class="layui-form-item">
                        <label class="layui-form-label">客户单号</label>
                        <div class="layui-input-block">
                            <input type="text" name="customerWaybillNo" placeholder="" class="layui-input" maxlength="20">
                        </div>
                    </div>
                </div>
                <div class="layui-col-sm3 layui-col-xs3">
                    <div class="layui-form-item">
                        <label class="layui-form-label">现金结算</label>
                        <div class="layui-input-block">
                            <input type="checkbox" name="receivableCashFlag" lay-skin="switch" lay-text="是|否">
                        </div>
                    </div>
                </div>
                <div class="layui-col-sm6 layui-col-xs6">
                    <div class="layui-form-item">
                        <label class="layui-form-label">应收备注</label>
                        <div class="layui-input-block">
                            <textarea name="receivableCostRemark" placeholder="输入应收费用备注，0~300字符" class="layui-input" maxlength="300" style="line-height:36px;"></textarea>
                        </div>
                    </div>
                </div>
            </div>
            <div class="layui-row">
                <div class="layui-col-sm12">
                    <div class="layui-form-item">
                        <label class="layui-form-label">回单附件</label>
                        <div class="layui-input-block">
                            <div class="file-line receiptAttList"></div>
                            <div class="file-upload-button">
                                <i class="layui-icon icon-folder">&#xe7a0;</i>
                            </div>
                            <input type="hidden" name="receiptAttId">
                        </div>
                    </div>
                </div>
            </div>
            <div class="layui-row">
                <div class="layui-col-sm12">
                    <div class="layui-form-item">
                        <label class="layui-form-label">票据附件</label>
                        <div class="layui-input-block">
                            <div class="file-line receivePaperAttList"></div>
                            <div class="file-upload-button">
                                <i class="layui-icon icon-folder">&#xe7a0;</i>
                            </div>
                            <input type="hidden" name="receivePaperAttId">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="buttonBar" class="layui-form-item button-bar">
            <button class="layui-btn layui-btn-normal" id="vsubmit" lay-submit lay-filter="submit">暂存</button>
            <button class="layui-btn" id="vadjust" lay-submit lay-filter="submit">审核</button>
            <button class="layui-btn layui-btn-primary" id="vclose" type="button">取消</button>
        </div>
    </form>
</body>
<script charset="utf-8" src="/view/frame/layui/layui.js"></script>
<script charset="utf-8" src="/view/frame/static/js/jquery.min.js?v=1.0"></script>
<script charset="utf-8" src="/view/tms/static/js/tms_index.js?v=1219"></script>

<script charset="utf-8" src="/view/frame/static/js/errorCodeMap.js"></script>
<script charset="utf-8" src="/view/frame/static/js/HC.js?v=1.4"></script>
<script charset="utf-8" src="/view/tms/static/js/validator.js"></script>
<script charset="utf-8" src="/view/tms/static/js/bizUtil.js"></script>

<script>
    layui.use(['form', 'layer', 'element'], function() {
        var form = layui.form,
            layer = layui.layer,
            $ = layui.jquery,
            element = layui.element;

        var $id = getUrlId($.trim(getUrlParam('id')));
        var $wrListArrs = [];

        //初始化主要信息
        $.get('/ucenter/tms/waybill/waybill/returnSingleDetail.shtml', {
            waybillId: $id
        }, function(d) {
            var $code = d.code,
                $msg = d.msg,
                $objects = d.objects;

            if (!$objects) {
                setLayerAlert(parent.layer, '数据获取异常，请关闭窗口', {
                    yes: function() {
                        parent.layer.closeAll();
                    }
                });
                return false;
            }

            if ($code === 'SUCCESS') {
                var $html = '<tr>' +
                    '<td>' + ($objects.jobNo || '-') + '</td>' +
                    '<td>' + ($objects.customerName || '-') + '</td>' +
                    '<td>' + (setStrFormat($objects.address, ';', '; ') || '-') + '</td>' +
                    '<td>' + ($objects.arkType || '-') + '</td>' +
                    '<td>' + ($objects.soNumber || '-') + '</td>' +
                    '<td>' + ($objects.arkNo || '-') + '</td>' +
                    '<td>' + ($objects.freightPrice || 0) + '</td>' +
                    '<td>' + ($objects.carNo || '-') + '/' + ($objects.carColor || '-') + '--' + ($objects.carframeNo || '-') + '/' + ($objects.carframeColor || '-') + '</td>' +
                    '<td>' + ($objects.driverName || '-') + '</td>' +
                    '<td>' + ($objects.driverMobile || '-') + '</td>' +
                    '</tr>';
                $('.main-ark tbody').append($html);

                //初始化上传附件
                $('.icon-folder').each(function() {
                    HC.upload({
                        // 触发上传的元素
                        elem: $(this),
                        // 多文件上传
                        multiple: true,
                        // 允许上传的文件类型 images（默认）、file、video、audio
                        accept: 'file',
                        // 最大文件大小限制（单位kb，默认不限制）
                        size: 1024,
                    }, {
                        layuiUpload: layui.upload,
                        // 指定 存放文件项的容器
                        fileItemContainer: $(this).parent().prev()
                    });
                });

                //初始化应收费用表单信息
                $('input[name="customerWaybillNo"]').val($objects.customerWaybillNo || '');
                $('input[name="receivableCashFlag"]').prop('checked',
                    ($objects.receivableCashFlag && $objects.receivableCashFlag == 1) ? true : false
                );
                $('textarea[name="receivableCostRemark"]').val($objects.receivableCostRemark || '');

                //初始化应收费用附件
                $('input[name="receiptAttId"]').val($objects.receiptAttId || '');
                $('input[name="receivePaperAttId"]').val($objects.receivePaperAttId || '');
                bizUtil.data.createFileItems(($objects.receiptAttList || []), $('.receiptAttList'));
                bizUtil.data.createFileItems(($objects.receivePaperAttList || []), $('.receivePaperAttList'));

                //初始化费用定义，1应收，2应付，3车辆
                $wrListArrs = setTableItem(1, '#receiveFreight table tbody', 4, 4, ($objects.wrList || []), 'wr-list-') || [];

                $('.layui-table').on('click', 'tbody:not(.tableEditing) td.amount', function(e) {
                    // var $thisCostName = $(this).prev('td').find('input').val();
                    // if ($thisCostName == '运费') {
                    //     layer.msg('运费不能编辑');
                    //     return false;
                    // }
                    $(this).find('span').hide();
                    $(this).find('input').addClass('inputEditing').show().focusEnd();
                    $(this).parents('tbody').addClass('tableEditing');
                })

                $('.layui-table').on('blur', 'input.inputEditing', function(e) {
                    var $bgColor = ['#fde2e2', '#fdfcd2'];
                    var $posNumReg = /^\d*\.?\d+$/;
                    var $val = $.trim($(this).val()),
                        $v1, $v2;
                    if ($val.length > 0) {
                        if (!$posNumReg.test($val)) {
                            layer.msg('请输入有效的费用');
                            $(this).css({
                                'background': $bgColor[0]
                            }).focus();
                            return;
                        } else if ($val == '0') {
                            // $v1 = '0';
                            // $v2 = '0';
                            $v1 = $v2 = '0';
                        } else {
                            $v1 = $v2 = Math.round(parseFloat($val) * 100) / 100;
                        }
                    } else {
                        $v1 = '-';
                        $v2 = '';
                    }
                    $(this).prev('span').text($v1).show();
                    $(this).removeClass('inputEditing').val($v2).css({
                        'background': $bgColor[1]
                    }).hide();
                    $(this).parents('tbody').removeClass('tableEditing');
                })

                //点击更多按钮
                var $moreArr = [
                    ['&#xe61a;', '展开更多费用'],
                    ['&#xe619;', '收起更多费用']
                ];
                $('.space-line a').on('click', function() {
                    var $trHideObj = $(this).parent().prev('table').find('tbody tr.tr-hide');
                    if ($trHideObj.length > 0) {
                        if ($trHideObj.is(':hidden')) {
                            $trHideObj.show();
                            $(this).html('<i class="layui-icon">' + $moreArr[1][0] + '</i>' + $moreArr[1][1] + '</a>');
                        } else {
                            $trHideObj.hide();
                            $(this).html('<i class="layui-icon">' + $moreArr[0][0] + '</i>' + $moreArr[0][1] + '</a>');
                        }
                    }
                });
                form.render('checkbox');
            }
        }, 'JSON');

        //画表（t：1应收，2应付，3车辆）（o：表格容器）（l：几列一组）（r：一行几组）（arrs：相对应数据组）（tit：标头）
        function setTableItem(t, o, l, r, arrs, tit) {
            var $arrs = [];
            // var $tableItems = getCostItem(t, '集港'),
            var $tableItems = arrs,
                $html = '',
                $class = '';

            if ($tableItems.length > 0) {
                var $priorLen = 0; //常用项条数
                for (var $i = 0; $i < $tableItems.length; $i++) {
                    if ($tableItems[$i].prior > 0) $priorLen++;
                    $html += (($i + 1) % r == 1) ? '<tr>' : '';
                    var $rid, $wid, $titid, $name, $amount, $amount1, $hasInvoice;
                    switch (t) {
                        case 1:
                            $rid = $tableItems[$i].id || '';
                            $wid = $tableItems[$i].recostItemId;
                            $titid = tit + $tableItems[$i].recostItemId;
                            $name = $tableItems[$i].recostName;
                            $amount = $tableItems[$i].recostAmount >= 0 ? $tableItems[$i].recostAmount : '-';
                            $amount1 = $tableItems[$i].recostAmount >= 0 ? $tableItems[$i].recostAmount : '';
                            $hasInvoice = $tableItems[$i].hasInvoice == 1 ? 'checked' : '';
                            break;
                        case 2:
                            $rid = $tableItems[$i].id || '';
                            $wid = $tableItems[$i].hacostItemId;
                            $titid = tit + $tableItems[$i].hacostItemId;
                            $name = $tableItems[$i].hacostName;
                            $amount = $tableItems[$i].hacostAmount >= 0 ? $tableItems[$i].hacostAmount : '-';
                            $amount1 = $tableItems[$i].hacostAmount >= 0 ? $tableItems[$i].hacostAmount : '';
                            break;
                        case 3:
                            $rid = $tableItems[$i].id || '';
                            $wid = $tableItems[$i].carcostItemId;
                            $titid = tit + $tableItems[$i].carcostItemId;
                            $name = $tableItems[$i].carcostName;
                            $amount = $tableItems[$i].carcostAmount >= 0 ? $tableItems[$i].carcostAmount : '-';
                            $amount1 = $tableItems[$i].carcostAmount >= 0 ? $tableItems[$i].carcostAmount : '';
                            break;
                        default:
                            break;
                    }
                    if (l == 4) {
                        $class = (($i + 1) % r == 0) ? '' : 'class="b"';
                        $html +=
                            '<td>' + ($i + 1) +
                            '<input type="hidden" name="id-' + $titid + '" value="' + $rid + '">' +
                            '<input type="hidden" name="cost-id-' + $titid + '" value="' + $wid + '"></td>' +
                            '<td>' + $name +
                            '<input type="hidden" name="cost-name-' + $titid + '" value="' + $name + '"></td>' +
                            '<td class="amount"><span>' + $amount + '</span>' +
                            '<input type="text" name="cost-amount-' + $titid + '" value="' + $amount1 + '" maxlength="10"></td>' +
                            '<td ' + $class + '>' +
                            '<input type="checkbox" name="has-invoice-' + $titid + '" lay-skin="primary" ' + $hasInvoice + '></td>';
                    } else if (l == 3) {
                        $class = (($i + 1) % r == 0) ? 'class="amount"' : 'class="b amount"';
                        $html +=
                            '<td>' + ($i + 1) +
                            '<input type="hidden" name="id-' + $titid + '" value="' + $rid + '">' +
                            '<input type="hidden" name="cost-id-' + $titid + '" value="' + $wid + '"></td>' +
                            '<td>' + $name +
                            '<input type="hidden" name="cost-name-' + $titid + '" value="' + $name + '"></td>' +
                            '<td ' + $class + '><span>' + $amount + '</span>' +
                            '<input type="text" name="cost-amount-' + $titid + '" value="' + $amount1 + '" maxlength="10"></td>';
                    }
                    $html += (($i + 1) % r == 0 || ($i + 1) == $tableItems.length) ? '</tr>' : '';
                    $arrs.push($titid);
                }
                $(o).html($html);

                //补缺少的单元格
                if (l == 4) form.render('checkbox');
                var $totalCol = Math.ceil($tableItems.length / r); //总行数
                var $totalLen = $totalCol * r; //总列数
                var $d = $totalLen - $tableItems.length;
                var $sHtml = '';
                if ($d > 0) {
                    for (var $n = 0; $n < $d; $n++) {
                        if (l == 4) {
                            $sHtml += ($n == $d - 1) ? '<td></td><td></td><td></td><td></td>' : '<td></td><td></td><td></td><td class="b"></td>';
                        } else if (l == 3) {
                            $sHtml += ($n == $d - 1) ? '<td></td><td></td><td></td>' : '<td></td><td></td><td class="b"></td>';
                        }
                    }
                    $(o).find('tr:last-child').append($sHtml);
                }

                //隐藏不常用的行（应收和应付）
                if (t < 3) {
                    var $priorCol = Math.ceil($priorLen / r); //常用项的总行数
                    $(o).find('tr').slice($priorCol, $totalCol).addClass('tr-hide');
                }
            }
            return $arrs;
        }

        //生成已填运费的数据，t：1应收，2应付，3车辆
        function setDataArrs(t, arrs) {
            var $nArrs = [];
            if (arrs.length > 0) {
                for (var $i = 0; $i < arrs.length; $i++) {
                    var $idVal = $('input[name="id-' + arrs[$i] + '"]').val(),
                        $costIdVal = $('input[name="cost-id-' + arrs[$i] + '"]').val(),
                        $costNameVal = $('input[name="cost-name-' + arrs[$i] + '"]').val(),
                        $costAmountVal = $('input[name="cost-amount-' + arrs[$i] + '"]').val(),
                        $hasInvoiceVal = $('input[name="has-invoice-' + arrs[$i] + '"]:checked').val();

                    if ($idVal.length > 0 && $costAmountVal.length == 0) $costAmountVal = '0';

                    if ($costAmountVal.length > 0) {
                        var $objs = {};
                        switch (t) {
                            case 1:
                                $objs.id = parseInt($idVal) || null;
                                $objs.recostItemId = parseInt($costIdVal);
                                $objs.recostName = $costNameVal;
                                $objs.recostAmount = parseFloat($costAmountVal);
                                $objs.hasInvoice = ($hasInvoiceVal == 'on') ? 1 : 0;
                                break;
                            case 2:
                                $objs.id = parseInt($idVal) || null;
                                $objs.hacostItemId = parseInt($costIdVal);
                                $objs.hacostName = $costNameVal;
                                $objs.hacostAmount = parseFloat($costAmountVal);
                                break;
                            case 3:
                                $objs.id = parseInt($idVal) || null;
                                $objs.carcostItemId = parseInt($costIdVal);
                                $objs.carcostName = $costNameVal;
                                $objs.carcostAmount = parseFloat($costAmountVal);
                                break;
                            default:
                                break;
                        }
                        $nArrs.push($objs);
                    }
                }
            }
            return $nArrs;
        }

        //监听提交
        form.on('submit(submit)', function(data) {
            if (!bizUtil.validator.verifyContainer($('form'))) {
                return false;
            }

            var $saveType = $(this).attr('id'),
                $saveText = '';

            //数据源
            var $saveData = {
                waybillId: $id,
                wrRemark: data.field.receivableCostRemark,
                wrHasCash: data.field.receivableCashFlag == 'on' ? 1 : 0,
                customerWaybillNo: data.field.customerWaybillNo
            };

            //应收费用
            var wrList = setDataArrs(1, $wrListArrs);
            $saveData.wrList = (wrList.length > 0) ? wrList : null;

            //提交按钮
            switch ($saveType) {
                case 'vsubmit': //暂存
                    $saveData.hasSubmit = false;
                    $saveText = '暂存';
                    break;
                case 'vadjust': //审核
                    $saveData.hasSubmit = true;
                    $saveText = '审核';
                    break;
                default:
                    break;
            }

            //票据附件
            var errorIds = [];
            var getAttrData = function(obj) {
                var attrData = bizUtil.data.getAttrDataList(obj);
                var newAttrData = [];
                if (attrData.length > 0) {
                    $.each(attrData, function(k, v) {
                        if (!v.attFileUrl) {
                            errorIds.push(k);
                        }
                    });
                }
                if (errorIds.length == 0) {
                    newAttrData = attrData;
                }
                return newAttrData;
            }

            //应收回单附件
            $saveData.receiptAttId = parseInt(data.field.receiptAttId) || null;
            var receiptAttList = getAttrData($('.receiptAttList'));
            $saveData.receiptAttList = receiptAttList;

            //应收票据附件
            $saveData.receivePaperAttId = parseInt(data.field.receivePaperAttId) || null;
            var receivePaperAttList = getAttrData($('.receivePaperAttList'));
            $saveData.receivePaperAttList = receivePaperAttList;

            if (errorIds.length > 0) {
                layer.msg('附件中有上传失败的文件，请重新上传或删除');
                return false;
            }

            // console.log($saveData);
            // return false;

            //提交确认撤柜
            HC.ajax['post']({
                url: '/ucenter/tms/waybill/waybill/updateCost.shtml',
                data: $saveData,
                success: function() {
                    setLayerAlert(parent.layer, $saveText + '成功', {
                        yes: function() {
                            parent.layer.closeAll();
                            // bizUtil.frame.refreshListFrame();
                            //获取当前框架ID并刷新
                            var $layId = $(window.parent.document).find('.layui-this').attr('lay-id');
                            parent['f' + $layId].refreshTableList();
                        }
                    });
                }
            });

            return false;
        });

        //取消按钮
        $('#vclose').on('click', function() {
            parent.layer.closeAll();
        });
    });
</script>

</html>