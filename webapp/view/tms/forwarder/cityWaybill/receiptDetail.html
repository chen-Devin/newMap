<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>城配运单 - 回单详情 - TMS</title>
    <link rel="stylesheet" href="/view/frame/layui/css/layui.css" media="all">
    <link rel="stylesheet" href="/view/frame/static/css/global.css?v=1.0">
    <link rel="stylesheet" href="/view/tms/static/css/add.css?v=1.0">
    <style>
        .layui-form-item .layui-form-label {
            width: 65px;
            padding: 9px 0;
            text-align: left;
        }
        
        .layui-form-item .layui-input-block {
            margin-left: 65px;
        }
        
        .layui-table {
            margin-bottom: 0;
        }
        
        .layui-table th {
            font-weight: bold;
        }
        
        .layui-table th,
        .layui-table td {
            text-align: center;
        }
        
        .layui-table th.b,
        .layui-table td.b {
            border-right: #bbb 2px solid;
        }
        
        .layui-table td.h {
            background: #efefef;
        }
        
        .layui-table td.amount {
            padding: 0;
        }
        
        .message-box {
            margin: 5px 0;
            line-height: 24px;
            color: #999;
        }
        
        .amount,
        .message-box span {
            color: #000;
        }
        
        .file-item .icon-delete {
            display: none;
        }
        
        #trailerSettlementId {
            display: none;
        }
    </style>
</head>

<body>
    <form class="layui-form" autocomplete="off" style="min-width:800px;">
        <fieldset class="layui-elem-field layui-field-title" style="margin-top:20px;">
            <legend>主要信息</legend>
        </fieldset>
        <table class="layui-table main-ark">
            <thead>
                <tr>
                    <th>作业单号</th>
                    <th>客户名称</th>
                    <th>装货地点</th>
                    <th>卸货地点</th>
                    <th>箱型</th>
                    <th>拖车车牌</th>
                    <th>司机</th>
                    <th>司机手机</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <fieldset class="layui-elem-field layui-field-title" style="margin-top:10px;">
            <legend>应收费用</legend>
        </fieldset>
        <div class="layui-tab layui-tab-card">
            <ul class="layui-tab-title"></ul>
            <div class="layui-tab-content" style="padding:0 10px;"></div>
        </div>

        <fieldset class="layui-elem-field layui-field-title" style="margin-top:10px;">
            <legend>应付费用</legend>
        </fieldset>
        <table class="layui-table" id="handleFreight" lay-size="sm">
            <colgroup>
                <col width="80">
                <col width="100">
                <col width="100">
                <col width="80">
                <col width="100">
                <col width="100">
                <col width="80">
                <col width="100">
                <col width="100">
                <col width="80">
                <col width="100">
                <col width="100">
            </colgroup>
            <thead>
                <tr>
                    <th>序号</th>
                    <th>费用</th>
                    <th class="b">金额</th>
                    <th>序号</th>
                    <th>费用</th>
                    <th class="b">金额</th>
                    <th>序号</th>
                    <th>费用</th>
                    <th class="b">金额</th>
                    <th>序号</th>
                    <th>费用</th>
                    <th>金额</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <div class="layui-row message-box">
            <div class="layui-col-sm2 layui-col-xs2" id="trailerSettlementId">
                结算对象：<span name="trailerSettlementId"></span>
            </div>
            <div class="layui-col-sm3 layui-col-xs3" id="prepaidFreight">
                预付车费：<span name="prepaidFreight"></span>
            </div>
            <div class="layui-col-sm3 layui-col-xs3" id="whCash">
                现金结算：<span name="whCash"></span>
            </div>
            <div class="layui-col-sm6 layui-col-xs6">
                应付备注：<span name="whRemark"></span>
            </div>
        </div>

        <fieldset class="layui-elem-field layui-field-title" style="margin-top:10px;">
            <legend>车辆成本</legend>
        </fieldset>
        <table class="layui-table" id="carFreight" lay-size="sm">
            <colgroup>
                <col width="80">
                <col width="100">
                <col width="100">
                <col width="80">
                <col width="100">
                <col width="100">
                <col width="80">
                <col width="100">
                <col width="100">
                <col width="80">
                <col width="100">
                <col width="100">
            </colgroup>
            <thead>
                <tr>
                    <th>序号</th>
                    <th>费用</th>
                    <th class="b">金额</th>
                    <th>序号</th>
                    <th>费用</th>
                    <th class="b">金额</th>
                    <th>序号</th>
                    <th>费用</th>
                    <th class="b">金额</th>
                    <th>序号</th>
                    <th>费用</th>
                    <th>金额</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </form>
</body>
<script charset="utf-8" src="/view/frame/layui/layui.js"></script>
<script charset="utf-8" src="/view/frame/static/js/jquery.min.js?v=1.0"></script>
<script charset="utf-8" src="/view/frame/static/js/lang_zh_CN.js?v=1.0"></script>
<script charset="utf-8" src="/view/tms/static/js/tms_index.js?v=1219"></script>

<script charset="utf-8" src="/view/frame/static/js/errorCodeMap.js"></script>
<script charset="utf-8" src="/view/frame/static/js/HC.js?v=1.4"></script>
<script charset="utf-8" src="/view/tms/static/js/validator.js"></script>
<script charset="utf-8" src="/view/tms/static/js/bizUtil.js"></script>

<script>
    layui.use(['form', 'layer', 'element'], function() {
        var form = layui.form,
            layer = layui.layer,
            $ = layui.jquery,
            element = layui.element;

        var $id = getUrlId($.trim(getUrlParam('id')));
        var $wrArrs = [],
            $whArrs = [],
            $wcArrs = [];

        //初始化主要信息
        $.get('/ucenter/tms/city/cityWaybill/getReturnDetail.shtml', {
            id: $id
        }, function(d) {
            var $code = d.code,
                $msg = d.msg,
                $objects = d.objects;

            if ($code === 'SUCCESS') {
                if ($objects == null) {
                    setLayerAlert(parent.layer, '数据获取异常，请关闭窗口', {
                        yes: function() {
                            parent.layer.closeAll();
                        }
                    });
                    return false;
                }
                var $html = '<tr>' +
                    '<td>' + ($objects.jobNo || '-') + '</td>' +
                    '<td>' + (setStrFormat($objects.customerName, '#&', '; ') || '-') + '</td>' +
                    '<td>' + (setStrFormat($objects.loadAddress, ';', '; ') || '-') + '</td>' +
                    '<td>' + (setStrFormat($objects.unLoadAddress, ';', '; ') || '-') + '</td>' +
                    '<td>' + ($objects.arkType || '-') + '</td>' +
                    '<td>' + ($objects.carNo || '-') + '</td>' +
                    '<td>' + ($objects.driverName || '-') + '</td>' +
                    '<td>' + ($objects.driverMobile || '-') + '</td>' +
                    '</tr>';
                $('.main-ark tbody').append($html);

                //多客户应收费用
                var layuiTabTitle = $('.layui-tab .layui-tab-title'),
                    layuiTabContent = $('.layui-tab .layui-tab-content');
                if ($objects.rrcList != null && $objects.rrcList.length > 0) {
                    for (var i = 0; i < $objects.rrcList.length; i++) {
                        //添加多客户标签
                        layuiTabTitle.append('<li>' + $objects.rrcList[i].customerName + '</li>');
                        //添加多客户内容
                        layuiTabContent.append('<div class="layui-tab-item"></div>');
                        //默认第一个选中
                        if (i == 0) {
                            layuiTabTitle.find('li:first-child').addClass('layui-this');
                            layuiTabContent.find('.layui-tab-item:first-child').addClass('layui-show');
                        }
                        //开始画客户内容表
                        var customerId = $objects.rrcList[i].customerId;
                        var receiveTableHtml = [
                            '<div id="reveiveTable', customerId, '">',
                            '<table class="layui-table" id="receiveFreight', customerId, '" lay-size="sm">',
                            '    <colgroup>',
                            '        <col width="80">',
                            '        <col width="100">',
                            '        <col width="100">',
                            '        <col width="100">',
                            '        <col width="80">',
                            '        <col width="100">',
                            '        <col width="100">',
                            '        <col width="100">',
                            '        <col width="80">',
                            '        <col width="100">',
                            '        <col width="100">',
                            '        <col width="100">',
                            '        <col width="80">',
                            '        <col width="100">',
                            '        <col width="100">',
                            '        <col width="100">',
                            '    </colgroup>',
                            '    <thead>',
                            '        <tr>',
                            '            <th>序号</th>',
                            '            <th>费用</th>',
                            '            <th>金额</th>',
                            '            <th class="b">开发票</th>',
                            '            <th>序号</th>',
                            '            <th>费用</th>',
                            '            <th>金额</th>',
                            '            <th class="b">开发票</th>',
                            '            <th>序号</th>',
                            '            <th>费用</th>',
                            '            <th>金额</th>',
                            '            <th class="b">开发票</th>',
                            '            <th>序号</th>',
                            '            <th>费用</th>',
                            '            <th>金额</th>',
                            '            <th>开发票</th>',
                            '        </tr>',
                            '    </thead>',
                            '    <tbody></tbody>',
                            '</table>',
                            '<div class="layui-row message-box">',
                            '    <div class="layui-col-sm3 layui-col-xs3">',
                            '        客户单号：<span name="customerWaybillNo', customerId, '"></span>',
                            '    </div>',
                            '    <div class="layui-col-sm3 layui-col-xs3">',
                            '        现金结算：<span name="receivableCashFlag', customerId, '"></span>',
                            '    </div>',
                            '    <div class="layui-col-sm6 layui-col-xs6">',
                            '        应收备注：<span name="receivableCostRemark', customerId, '"></span>',
                            '    </div>',
                            '</div>',
                            '<div class="layui-row">',
                            '    <div class="layui-col-sm12">',
                            '        <div class="layui-form-item">',
                            '            <label class="layui-form-label">回单附件</label>',
                            '            <div class="layui-input-block">',
                            '                <div class="file-line returnListAtts', customerId, '"></div>',
                            '            </div>',
                            '        </div>',
                            '    </div>',
                            '</div>',
                            '<div class="layui-row">',
                            '    <div class="layui-col-sm12">',
                            '        <div class="layui-form-item">',
                            '            <label class="layui-form-label">票据附件</label>',
                            '            <div class="layui-input-block">',
                            '                <div class="file-line receiptListAtts', customerId, '"></div>',
                            '            </div>',
                            '            </div>',
                            '        </div>',
                            '    </div>',
                            '</div>',
                            '</div>'
                        ].join('');
                        layuiTabContent.find('.layui-tab-item').eq(i).append(receiveTableHtml);
                        //应收费用客户单号、备注、现金结算
                        $('span[name="customerWaybillNo' + customerId + '"]').html($objects.rrcList[i].customerWaybillNo || '--');
                        $('span[name="receivableCostRemark' + customerId + '"]').html($objects.rrcList[i].receivableCostRemark || '--');
                        $('span[name="receivableCashFlag' + customerId + '"]').html(
                            ($objects.rrcList[i].receivableCashFlag != null && $objects.rrcList[i].receivableCashFlag == 1) ? '是' : '否'
                        );
                        //应收费用价格项
                        var $wrArrs = $objects.rrcList[i].wrList;
                        if ($wrArrs != null && $wrArrs.length > 0) {
                            setTableItem(1, '#receiveFreight' + customerId + ' tbody', 4, 4, $wrArrs);
                        }
                        //回单附件
                        bizUtil.data.createFileItems(($objects.rrcList[i].detailList[0].returnListAtts || []), $('.returnListAtts' + customerId));
                        //票据附件
                        bizUtil.data.createFileItems(($objects.rrcList[i].detailList[0].receiptListAtts || []), $('.receiptListAtts' + customerId));
                    }
                }

                //初始化上传附件 鼠标悬浮时 弹出预览图 的效果
                HC.uploadUtil.bindPreviewImgEvent($('#reveiveTable12'));
                // 绑定图片查看器功能
                HC.uploadUtil.bindImgGalleryEvent($('#reveiveTable12'));

                //应付费用备注、现金结算、预付车费、结算对象
                var layuiColClass = 'layui-col-sm2 layui-col-xs2';
                if ($objects.carId && $objects.trailerSettlementId) {
                    //获取结算对象名称
                    $.get('/ucenter/settlementchannel/options.shtml', {
                        waybillId: $id,
                        trailerId: $objects.carId,
                        supplierId: ($objects.carCompanyId || '')
                    }, function(d) {
                        if (d.code === 'SUCCESS') {
                            $('#trailerSettlementId').show();
                            $('#prepaidFreight').attr('class', layuiColClass);
                            $('#whCash').attr('class', layuiColClass);
                            if (d.objects.length > 0) {
                                $.each(d.objects, function(k, v) {
                                    if (v.key == $objects.trailerSettlementId) {
                                        $('span[name="trailerSettlementId"]').html(v.value);
                                    }
                                });
                            }
                        }
                    });
                }

                $('span[name="whRemark"]').html($objects.whRemark || '--');
                $('span[name="prepaidFreight"]').html($objects.prepaidFreight || '--');
                $('span[name="whCash"]').html(
                    ($objects.whCash != null && $objects.whCash == 1) ? '是' : '否'
                );

                //初始化费用定义，1应收，2应付，3车辆
                ($objects.whList != null) ? setTableItem(2, '#handleFreight tbody', 3, 4, $objects.whList): [];
                ($objects.wcList != null) ? setTableItem(3, '#carFreight tbody', 3, 4, $objects.wcList): [];

                form.render('checkbox');
            }
        }, 'JSON');

        //画表（t：1应收，2应付，3车辆）（o：表格容器）（l：几列一组）（r：一行几组）（arrs：相对应数据组）
        function setTableItem(t, o, l, r, arrs) {
            //var $tableItems = getCostItem(t),
            var $tableItems = arrs,
                $html = '',
                $class = '';
            if ($tableItems.length > 0) {
                var hasCostTotal = 0;
                for (var $i = 0; $i < $tableItems.length; $i++) {
                    if ($tableItems[$i].recostAmount > 0 || $tableItems[$i].hacostAmount > 0 || $tableItems[$i].carcostAmount > 0) {
                        var k = (hasCostTotal + 1) % r;
                        $html += (k == 1) ? '<tr>' : '';
                        var $rid, $wid, $name, $amount, $amount1, $hasInvoice;
                        switch (t) {
                            case 1:
                                $rid = $tableItems[$i].id;
                                $wid = $tableItems[$i].recostItemId;
                                $name = $tableItems[$i].recostName;
                                $amount = $tableItems[$i].recostAmount;
                                $hasInvoice = $tableItems[$i].hasInvoice == 1 ? 'checked' : '';
                                break;
                            case 2:
                                $rid = $tableItems[$i].id;
                                $wid = $tableItems[$i].hacostItemId;
                                $name = $tableItems[$i].hacostName;
                                $amount = $tableItems[$i].hacostAmount;
                                break;
                            case 3:
                                $rid = $tableItems[$i].id;
                                $wid = $tableItems[$i].carcostItemId;
                                $name = $tableItems[$i].carcostName;
                                $amount = $tableItems[$i].carcostAmount;
                                break;
                            default:
                                break;
                        }
                        if (l == 4) {
                            $class = (k == 0) ? '' : 'class="b"';
                            $html += '<td>' + (hasCostTotal + 1) + '</td>' +
                                '<td>' + $name + '</td>' +
                                '<td class="amount">' + $amount + '</td>' +
                                '<td ' + $class + '><input type="checkbox" name="hasInvoice' + $wid + '" lay-skin="primary" ' + $hasInvoice + ' disabled></td>';
                        } else if (l == 3) {
                            $class = (k == 0) ? 'class="amount"' : 'class="b amount"';
                            $html += '<td>' + (hasCostTotal + 1) + '</td>' +
                                '<td>' + $name + '</td>' +
                                '<td ' + $class + '>' + $amount + '</td>';
                        }
                        $html += (k == 0 || (hasCostTotal + 1) == $tableItems.length) ? '</tr>' : '';
                        hasCostTotal++;
                    }
                    $(o).html($html);
                }

                //补缺少的单元格
                if (l == 4) form.render('checkbox');
                var $totalCol = Math.ceil(hasCostTotal / r); //总行数
                var $totalLen = $totalCol * r; //总列数
                var $d = $totalLen - hasCostTotal;
                var $sHtml = '';
                if ($d > 0) {
                    for (var $n = 0; $n < $d; $n++) {
                        if (l == 4) {
                            $sHtml += ($n == $d - 1) ? '<td></td><td></td><td></td><td></td>' : '<td></td><td></td><td></td><td class="b"></td>';
                        } else if (l == 3) {
                            $sHtml += ($n == $d - 1) ? '<td></td><td></td><td></td>' : '<td></td><td></td><td class="b"></td>';
                        }
                    }
                    $(o).find('tr:last-child').append($sHtml);
                }
            }
        }
    });
</script>

</html>