<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>城配运单 - 回单 - TMS</title>
    <link rel="stylesheet" href="/view/frame/layui/css/layui.css" media="all">
    <link rel="stylesheet" href="/view/frame/static/css/global.css?v=1.0">
    <link rel="stylesheet" href="/view/tms/static/css/add.css?v=1.0">
    <style>
        .layui-form-item .layui-form-label {
            width: 60px;
        }
        
        .layui-form-item .layui-input-block {
            margin-left: 90px;
        }
        
        .button-bar {
            text-align: center;
            margin: 20px 0 30px;
        }
        
        .layui-table {
            margin-bottom: 5px;
        }
        
        .layui-table th {
            font-weight: bold;
        }
        
        .layui-table th,
        .layui-table td {
            text-align: center;
        }
        
        .layui-table th.b,
        .layui-table td.b {
            border-right: #bbb 2px solid;
        }
        
        .layui-table td.h {
            background: #efefef;
        }
        
        .layui-table td.amount {
            padding: 0;
        }
        
        .layui-table td.amount input {
            display: none;
            width: 100%;
            height: 30px;
            background: #fdfcd2;
            border: 0;
        }
        
        .space-line {
            height: 13px;
            line-height: 13px;
            text-align: right;
            font-size: 12px;
            margin-bottom: 5px;
            overflow: hidden;
        }
        
        .space-line a {
            color: #1E9FFF;
        }
        
        .tr-hide {
            display: none;
        }
        
        #trailerSettlementId {
            display: none;
        }
    </style>
</head>

<body>
    <form class="layui-form" autocomplete="off" style="min-width:800px;">
        <fieldset class="layui-elem-field layui-field-title" style="margin-top:20px;">
            <legend>主要信息</legend>
        </fieldset>
        <table class="layui-table main-ark">
            <thead>
                <tr>
                    <th>作业单号</th>
                    <th>客户名称</th>
                    <th>装货地点</th>
                    <th>卸货地点</th>
                    <th>箱型</th>
                    <th>拖车车牌</th>
                    <th>司机</th>
                    <th>司机手机</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <fieldset class="layui-elem-field layui-field-title" style="margin-top:20px;">
            <legend>应收费用</legend>
        </fieldset>
        <div class="layui-tab layui-tab-card">
            <ul class="layui-tab-title"></ul>
            <div class="layui-tab-content" style="padding:0 10px;"></div>
            <input type="hidden" name="freight">
        </div>

        <fieldset class="layui-elem-field layui-field-title" style="margin-top:20px;">
            <legend>应付费用</legend>
        </fieldset>
        <table class="layui-table" id="handleFreight" lay-size="sm">
            <colgroup>
                <col width="80">
                <col width="100">
                <col width="100">
                <col width="80">
                <col width="100">
                <col width="100">
                <col width="80">
                <col width="100">
                <col width="100">
                <col width="80">
                <col width="100">
                <col width="100">
            </colgroup>
            <thead>
                <tr>
                    <th>序号</th>
                    <th>费用</th>
                    <th class="b">金额</th>
                    <th>序号</th>
                    <th>费用</th>
                    <th class="b">金额</th>
                    <th>序号</th>
                    <th>费用</th>
                    <th class="b">金额</th>
                    <th>序号</th>
                    <th>费用</th>
                    <th>金额</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <div class="space-line"><a><i class="layui-icon">&#xe61a;</i>展开更多费用</a></div>
        <div class="layui-row">
            <div class="layui-col-sm2 layui-col-xs2" id="trailerSettlementId">
                <div class="layui-form-item">
                    <label class="layui-form-label">结算对象</label>
                    <div class="layui-input-block">
                        <select name="trailerSettlementId">
                            <option value="" selected>请选择</option>
                            <option value="..." disabled>数据加载中...</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="layui-col-sm4 layui-col-xs4" id="prepaidFreight">
                <div class="layui-form-item">
                    <label class="layui-form-label">预付车费</label>
                    <div class="layui-input-block">
                        <input type="text" name="prepaidFreight" placeholder="" class="layui-input" hc-verify="decimals2|billionDecimals2" hc-verify_field="预付车费">
                    </div>
                </div>
            </div>
            <div class="layui-col-sm2 layui-col-xs2" id="whCash">
                <div class="layui-form-item">
                    <label class="layui-form-label">现金结算</label>
                    <div class="layui-input-block">
                        <input type="checkbox" name="whCash" lay-skin="switch" lay-text="是|否">
                    </div>
                </div>
            </div>
            <div class="layui-col-sm6 layui-col-xs6">
                <div class="layui-form-item">
                    <label class="layui-form-label">应付备注</label>
                    <div class="layui-input-block">
                        <textarea name="whRemark" lay-verify="whRemark" placeholder="输入应付费用备注，0~300字符" class="layui-input" maxlength="300" style="line-height:36px;"></textarea>
                    </div>
                </div>
            </div>
        </div>

        <fieldset class="layui-elem-field layui-field-title" style="margin-top:5px;">
            <legend>车辆成本</legend>
        </fieldset>
        <table class="layui-table" id="carFreight" lay-size="sm">
            <colgroup>
                <col width="80">
                <col width="100">
                <col width="100">
                <col width="80">
                <col width="100">
                <col width="100">
                <col width="80">
                <col width="100">
                <col width="100">
                <col width="80">
                <col width="100">
                <col width="100">
            </colgroup>
            <thead>
                <tr>
                    <th>序号</th>
                    <th>费用</th>
                    <th class="b">金额</th>
                    <th>序号</th>
                    <th>费用</th>
                    <th class="b">金额</th>
                    <th>序号</th>
                    <th>费用</th>
                    <th class="b">金额</th>
                    <th>序号</th>
                    <th>费用</th>
                    <th>金额</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <div class="layui-form-item button-bar">
            <button class="layui-btn layui-btn-normal" id="vsubmit" lay-submit lay-filter="submit">暂存</button>
            <button class="layui-btn" id="vreceipt" lay-submit lay-filter="submit">回单</button>
            <button class="layui-btn layui-btn-primary" id="vclose" type="button">取消</button>
        </div>
    </form>
</body>
<script charset="utf-8" src="/view/frame/layui/layui.js"></script>
<script charset="utf-8" src="/view/frame/static/js/jquery.min.js?v=1.0"></script>
<script charset="utf-8" src="/view/frame/static/js/lang_zh_CN.js?v=1.0"></script>
<script charset="utf-8" src="/view/tms/static/js/tms_index.js?v=1219"></script>

<script charset="utf-8" src="/view/frame/static/js/errorCodeMap.js"></script>
<script charset="utf-8" src="/view/frame/static/js/HC.js?v=1.4"></script>
<script charset="utf-8" src="/view/tms/static/js/validator.js"></script>
<script charset="utf-8" src="/view/tms/static/js/bizUtil.js"></script>

<script>
    layui.use(['form', 'layer', 'element'], function() {
        var form = layui.form,
            layer = layui.layer,
            $ = layui.jquery,
            element = layui.element;

        var $id = getUrlId($.trim(getUrlParam('id')));
        var $wrListArrs = [],
            $whListArrs = [],
            $wcListArrs = [];

        //初始化主要信息
        $.get('/ucenter/tms/city/cityWaybill/getReturnDetail.shtml', {
            id: $id
        }, function(d) {
            var $code = d.code,
                $msg = d.msg,
                $objects = d.objects;

            if ($code === 'SUCCESS') {
                if ($objects == null) {
                    setLayerAlert(parent.layer, '数据获取异常，请关闭窗口', {
                        yes: function() {
                            parent.layer.closeAll();
                        }
                    });
                    return false;
                }
                var $html = '<tr>' +
                    '<td>' + ($objects.jobNo || '-') + '</td>' +
                    '<td>' + (setStrFormat($objects.customerName, '#&', '; ') || '-') + '</td>' +
                    '<td>' + (setStrFormat($objects.loadAddress, ';', '; ') || '-') + '</td>' +
                    '<td>' + (setStrFormat($objects.unLoadAddress, ';', '; ') || '-') + '</td>' +
                    '<td>' + ($objects.arkType || '-') + '</td>' +
                    '<td>' + ($objects.carNo || '-') + '</td>' +
                    '<td>' + ($objects.driverName || '-') + '</td>' +
                    '<td>' + ($objects.driverMobile || '-') + '</td>' +
                    '</tr>';
                $('.main-ark tbody').append($html);

                //多客户应收费用
                var layuiTabTitle = $('.layui-tab .layui-tab-title'),
                    layuiTabContent = $('.layui-tab .layui-tab-content');
                if ($objects.rrcList != null && $objects.rrcList.length > 0) {
                    for (var i = 0; i < $objects.rrcList.length; i++) {
                        //添加多客户标签
                        layuiTabTitle.append('<li>' + $objects.rrcList[i].customerName + '</li>');
                        //添加多客户内容
                        layuiTabContent.append('<div class="layui-tab-item"></div>');
                        //默认第一个选中
                        if (i == 0) {
                            layuiTabTitle.find('li:first-child').addClass('layui-this');
                            layuiTabContent.find('.layui-tab-item:first-child').addClass('layui-show');
                        }
                        //开始画客户内容表
                        var customerId = $objects.rrcList[i].customerId;
                        var receiveTableHtml = [
                            '<div id="reveiveTable', customerId, '">',
                            '<table class="layui-table" id="receiveFreight', customerId, '" lay-size="sm">',
                            '    <colgroup>',
                            '        <col width="80">',
                            '        <col width="100">',
                            '        <col width="100">',
                            '        <col width="100">',
                            '        <col width="80">',
                            '        <col width="100">',
                            '        <col width="100">',
                            '        <col width="100">',
                            '        <col width="80">',
                            '        <col width="100">',
                            '        <col width="100">',
                            '        <col width="100">',
                            '        <col width="80">',
                            '        <col width="100">',
                            '        <col width="100">',
                            '        <col width="100">',
                            '    </colgroup>',
                            '    <thead>',
                            '        <tr>',
                            '            <th>序号</th>',
                            '            <th>费用</th>',
                            '            <th>金额</th>',
                            '            <th class="b">开发票</th>',
                            '            <th>序号</th>',
                            '            <th>费用</th>',
                            '            <th>金额</th>',
                            '            <th class="b">开发票</th>',
                            '            <th>序号</th>',
                            '            <th>费用</th>',
                            '            <th>金额</th>',
                            '            <th class="b">开发票</th>',
                            '            <th>序号</th>',
                            '            <th>费用</th>',
                            '            <th>金额</th>',
                            '            <th>开发票</th>',
                            '        </tr>',
                            '    </thead>',
                            '    <tbody></tbody>',
                            '</table>',
                            '<div class="space-line"><a><i class="layui-icon">&#xe61a;</i>展开更多费用</a></div>',
                            '<div class="layui-row">',
                            '    <div class="layui-col-sm4 layui-col-xs4">',
                            '        <div class="layui-form-item">',
                            '            <label class="layui-form-label">客户单号</label>',
                            '            <div class="layui-input-block">',
                            '                <input type="hidden" name="customerId', customerId, '">',
                            '                <input type="hidden" name="customerName', customerId, '">',
                            '                <input type="text" name="customerWaybillNo', customerId, '" placeholder="" class="layui-input" maxlength="50">',
                            '            </div>',
                            '        </div>',
                            '    </div>',
                            '    <div class="layui-col-sm2 layui-col-xs2">',
                            '        <div class="layui-form-item">',
                            '            <label class="layui-form-label">现金结算</label>',
                            '            <div class="layui-input-block">',
                            '                <input type="checkbox" name="receivableCashFlag', customerId, '" lay-skin="switch" lay-text="是|否">',
                            '            </div>',
                            '        </div>',
                            '    </div>',
                            '    <div class="layui-col-sm6 layui-col-xs6">',
                            '        <div class="layui-form-item">',
                            '            <label class="layui-form-label">应收备注</label>',
                            '            <div class="layui-input-block">',
                            '                <textarea name="receivableCostRemark', customerId, '" lay-verify="wrRemark" placeholder="输入应收费用备注，0~300字符" class="layui-input" maxlength="300" style="line-height:36px;"></textarea>',
                            '            </div>',
                            '        </div>',
                            '    </div>',
                            '</div>',
                            '<div class="layui-row">',
                            '    <div class="layui-col-sm12">',
                            '        <div class="layui-form-item">',
                            '            <label class="layui-form-label">回单附件</label>',
                            '            <div class="layui-input-block">',
                            '                <div class="file-line returnListAtts', customerId, '"></div>',
                            '                <div class="file-upload-button">',
                            '                    <i class="layui-icon icon-folder">&#xe7a0;</i>',
                            '                </div>',
                            '            </div>',
                            '        </div>',
                            '    </div>',
                            '</div>',
                            '<div class="layui-row">',
                            '    <div class="layui-col-sm12">',
                            '        <div class="layui-form-item">',
                            '            <label class="layui-form-label">票据附件</label>',
                            '            <div class="layui-input-block">',
                            '                <div class="file-line receiptListAtts', customerId, '"></div>',
                            '                <div class="file-upload-button">',
                            '                    <i class="layui-icon icon-folder">&#xe7a0;</i>',
                            '                </div>',
                            '            </div>',
                            '            </div>',
                            '        </div>',
                            '    </div>',
                            '</div>',
                            '</div>'
                        ].join('');
                        layuiTabContent.find('.layui-tab-item').eq(i).append(receiveTableHtml);
                        //应收费用客户单号、备注、现金结算
                        $('input[name="customerId' + customerId + '"]').val(customerId || '');
                        $('input[name="customerName' + customerId + '"]').val($objects.rrcList[i].customerName || '');
                        $('input[name="customerWaybillNo' + customerId + '"]').val($objects.rrcList[i].customerWaybillNo || '');
                        $('textarea[name="receivableCostRemark' + customerId + '"]').val($objects.rrcList[i].receivableCostRemark || '');
                        $('input[name="receivableCashFlag' + customerId + '"]').prop('checked',
                            ($objects.rrcList[i].receivableCashFlag != null && $objects.rrcList[i].receivableCashFlag == 1) ? true : false
                        );
                        //应收费用价格项
                        var $wrArrs = $objects.rrcList[i].wrList;
                        var $wrListArr = [];
                        if ($wrArrs != null && $wrArrs.length > 0) {
                            $wrListArr = setTableItem(1, '#receiveFreight' + customerId + ' tbody', 4, 4, $wrArrs, 'wr-list-' + customerId + '-') || [];
                            $wrListArrs.push($wrListArr);
                        }
                        //回单附件
                        bizUtil.data.createFileItems(($objects.rrcList[i].detailList[0].returnListAtts || []), $('.returnListAtts' + customerId));
                        //票据附件
                        bizUtil.data.createFileItems(($objects.rrcList[i].detailList[0].receiptListAtts || []), $('.receiptListAtts' + customerId));
                    }
                }

                //初始化上传附件
                $('.icon-folder').each(function() {
                    HC.upload({
                        // 触发上传的元素
                        elem: $(this),
                        // 多文件上传
                        multiple: true,
                        // 允许上传的文件类型 images（默认）、file、video、audio
                        accept: 'file',
                        // 最大文件大小限制（单位kb，默认不限制）
                        size: 1024,
                    }, {
                        layuiUpload: layui.upload,
                        // 指定 存放文件项的容器
                        fileItemContainer: $(this).parent().prev()
                    });
                });

                //初始化结算对象
                var layuiColClass = 'layui-col-sm2 layui-col-xs2';
                if ($objects.carId) {
                    $('#trailerSettlementId').show();
                    $('#prepaidFreight').attr('class', layuiColClass);
                    $('#whCash').attr('class', layuiColClass);
                    bizUtil.layui.loadDataToSelect($('select[name="trailerSettlementId"]'), {
                        value: $objects.trailerSettlementId,
                        dataUrl: '/ucenter/settlementchannel/options.shtml?waybillId=' + $id + '&trailerId=' + $objects.carId + '&supplierId=' + ($objects.carCompanyId || ''),
                        idFieldName: 'key',
                        textFieldName: 'value',
                        afterRenderCallback: function() {}
                    });
                }

                //应收运费总额
                $('input[name="freight"]').val($objects.freight || 0);

                //应付费用备注、现金结算、预付车费、结算对象
                //$('select[name="trailerSettlementId"]').val($objects.trailerSettlementId || '');
                $('textarea[name="whRemark"]').val($objects.whRemark || '');
                $('input[name="prepaidFreight"]').val($objects.prepaidFreight || '');
                $('input[name="whCash"]').prop('checked',
                    ($objects.whCash != null && $objects.whCash == 1) ? true : false
                );

                //初始化费用定义，1应收，2应付，3车辆
                $whListArrs = setTableItem(2, '#handleFreight tbody', 3, 4, $objects.whList, 'wh-list-') || [];
                $wcListArrs = setTableItem(3, '#carFreight tbody', 3, 4, $objects.wcList, 'wc-list-') || [];

                $('.layui-table').on('click', 'tbody:not(.tableEditing) td.amount', function(e) {
                    // var $thisCostName = $(this).prev('td').find('input').val();
                    // if ($thisCostName == '运费') {
                    //     layer.msg('运费不能编辑');
                    //     return false;
                    // }
                    $(this).find('span').hide();
                    $(this).find('input').addClass('inputEditing').show().focusEnd();
                    $(this).parents('tbody').addClass('tableEditing');
                })

                $('.layui-table').on('blur', 'input.inputEditing', function(e) {
                    var $bgColor = ['#fde2e2', '#fdfcd2'];
                    var $val = $.trim($(this).val()),
                        $v1, $v2;
                    if ($val.length > 0) {
                        if (!$jsReg.posNum.test($val)) {
                            layer.msg('请输入有效的费用');
                            $(this).css({
                                'background': $bgColor[0]
                            }).focus();
                            return;
                        } else if ($val == '0') {
                            $v1 = '-';
                            $v2 = '';
                        } else {
                            $v1 = $v2 = Math.round(parseFloat($val) * 100) / 100;
                        }
                    } else {
                        $v1 = '-';
                        $v2 = '';
                    }
                    $(this).prev('span').text($v1).show();
                    $(this).removeClass('inputEditing').val($v2).css({
                        'background': $bgColor[1]
                    }).hide();
                    $(this).parents('tbody').removeClass('tableEditing');
                })

                //点击更多按钮
                var $moreArr = [
                    ['&#xe61a;', '展开更多费用'],
                    ['&#xe619;', '收起更多费用']
                ];
                $('.space-line a').on('click', function() {
                    var $trHideObj = $(this).parent().prev('table').find('tbody tr.tr-hide');
                    if ($trHideObj.length > 0) {
                        if ($trHideObj.is(':hidden')) {
                            $trHideObj.show();
                            $(this).html('<i class="layui-icon">' + $moreArr[1][0] + '</i>' + $moreArr[1][1] + '</a>');
                        } else {
                            $trHideObj.hide();
                            $(this).html('<i class="layui-icon">' + $moreArr[0][0] + '</i>' + $moreArr[0][1] + '</a>');
                        }
                    }
                });
                form.render('checkbox');
            }
        }, 'JSON');

        //画表（t：1应收，2应付，3车辆）（o：表格容器）（l：几列一组）（r：一行几组）（arrs：相对应数据组）（tit：标头）
        function setTableItem(t, o, l, r, arrs, tit) {
            var $arrs = [];
            //var $tableItems = getCostItem(t),
            var $tableItems = arrs,
                $html = '',
                $class = '';
            if ($tableItems.length > 0) {
                var $priorLen = 0; //常用项条数
                for (var $i = 0; $i < $tableItems.length; $i++) {
                    if ($tableItems[$i].prior > 0) $priorLen++;
                    $html += (($i + 1) % r == 1) ? '<tr>' : '';
                    var $rid, $wid, $titid, $name, $amount, $amount1, $hasInvoice;
                    switch (t) {
                        case 1:
                            $rid = $tableItems[$i].id || '';
                            $wid = $tableItems[$i].recostItemId;
                            $titid = tit + $tableItems[$i].recostItemId;
                            $name = $tableItems[$i].recostName;
                            $amount = $tableItems[$i].recostAmount > 0 ? $tableItems[$i].recostAmount : '-';
                            $amount1 = $tableItems[$i].recostAmount > 0 ? $tableItems[$i].recostAmount : '';
                            $hasInvoice = $tableItems[$i].hasInvoice == 1 ? 'checked' : '';
                            break;
                        case 2:
                            $rid = $tableItems[$i].id || '';
                            $wid = $tableItems[$i].hacostItemId;
                            $titid = tit + $tableItems[$i].hacostItemId;
                            $name = $tableItems[$i].hacostName;
                            $amount = $tableItems[$i].hacostAmount > 0 ? $tableItems[$i].hacostAmount : '-';
                            $amount1 = $tableItems[$i].hacostAmount > 0 ? $tableItems[$i].hacostAmount : '';
                            break;
                        case 3:
                            $rid = $tableItems[$i].id || '';
                            $wid = $tableItems[$i].carcostItemId;
                            $titid = tit + $tableItems[$i].carcostItemId;
                            $name = $tableItems[$i].carcostName;
                            $amount = $tableItems[$i].carcostAmount > 0 ? $tableItems[$i].carcostAmount : '-';
                            $amount1 = $tableItems[$i].carcostAmount > 0 ? $tableItems[$i].carcostAmount : '';
                            break;
                        default:
                            break;
                    }
                    if (l == 4) {
                        $class = (($i + 1) % r == 0) ? '' : 'class="b"';
                        $html +=
                            '<td>' + ($i + 1) +
                            '<input type="hidden" name="id-' + $titid + '" value="' + $rid + '">' +
                            '<input type="hidden" name="cost-id-' + $titid + '" value="' + $wid + '"></td>' +
                            '<td>' + $name +
                            '<input type="hidden" name="cost-name-' + $titid + '" value="' + $name + '"></td>' +
                            '<td class="amount"><span>' + $amount + '</span>' +
                            '<input type="text" name="cost-amount-' + $titid + '" value="' + $amount1 + '" maxlength="10"></td>' +
                            '<td ' + $class + '>' +
                            '<input type="checkbox" name="has-invoice-' + $titid + '" lay-skin="primary" ' + $hasInvoice + '></td>';
                    } else if (l == 3) {
                        $class = (($i + 1) % r == 0) ? 'class="amount"' : 'class="b amount"';
                        $html +=
                            '<td>' + ($i + 1) +
                            '<input type="hidden" name="id-' + $titid + '" value="' + $rid + '">' +
                            '<input type="hidden" name="cost-id-' + $titid + '" value="' + $wid + '"></td>' +
                            '<td>' + $name +
                            '<input type="hidden" name="cost-name-' + $titid + '" value="' + $name + '"></td>' +
                            '<td ' + $class + '><span>' + $amount + '</span>' +
                            '<input type="text" name="cost-amount-' + $titid + '" value="' + $amount1 + '" maxlength="10"></td>';
                    }
                    $html += (($i + 1) % r == 0 || ($i + 1) == $tableItems.length) ? '</tr>' : '';
                    $arrs.push($titid);
                }
                $(o).html($html);

                //补缺少的单元格
                if (l == 4) form.render('checkbox');
                var $totalCol = Math.ceil($tableItems.length / r); //总行数
                var $totalLen = $totalCol * r; //总列数
                var $d = $totalLen - $tableItems.length;
                var $sHtml = '';
                if ($d > 0) {
                    for (var $n = 0; $n < $d; $n++) {
                        if (l == 4) {
                            $sHtml += ($n == $d - 1) ? '<td></td><td></td><td></td><td></td>' : '<td></td><td></td><td></td><td class="b"></td>';
                        } else if (l == 3) {
                            $sHtml += ($n == $d - 1) ? '<td></td><td></td><td></td>' : '<td></td><td></td><td class="b"></td>';
                        }
                    }
                    $(o).find('tr:last-child').append($sHtml);
                }

                //隐藏不常用的行（应收和应付）
                if (t < 3) {
                    var $priorCol = Math.ceil($priorLen / r); //常用项的总行数
                    $(o).find('tr').slice($priorCol, $totalCol).addClass('tr-hide');
                }
            }
            return $arrs;
        }

        //生成已填运费的数据，t：1应收，2应付，3车辆
        function setDataArrs(t, arrs) {
            var $nArrs = [];
            if (arrs.length > 0) {
                for (var $i = 0; $i < arrs.length; $i++) {
                    var $idVal = $('input[name="id-' + arrs[$i] + '"]').val(),
                        $costIdVal = $('input[name="cost-id-' + arrs[$i] + '"]').val(),
                        $costNameVal = $('input[name="cost-name-' + arrs[$i] + '"]').val(),
                        $costAmountVal = $('input[name="cost-amount-' + arrs[$i] + '"]').val(),
                        $hasInvoiceVal = $('input[name="has-invoice-' + arrs[$i] + '"]:checked').val();

                    if ($idVal.length > 0 && $costAmountVal.length == 0) $costAmountVal = '0';

                    if ($costAmountVal.length > 0) {
                        var $objs = {};
                        switch (t) {
                            case 1:
                                $objs.id = parseInt($idVal) || null;
                                $objs.recostItemId = parseInt($costIdVal);
                                $objs.recostName = $costNameVal;
                                $objs.recostAmount = parseFloat($costAmountVal);
                                $objs.hasInvoice = ($hasInvoiceVal == 'on') ? 1 : 0;
                                break;
                            case 2:
                                $objs.id = parseInt($idVal) || null;
                                $objs.hacostItemId = parseInt($costIdVal);
                                $objs.hacostName = $costNameVal;
                                $objs.hacostAmount = parseFloat($costAmountVal);
                                break;
                            case 3:
                                $objs.id = parseInt($idVal) || null;
                                $objs.carcostItemId = parseInt($costIdVal);
                                $objs.carcostName = $costNameVal;
                                $objs.carcostAmount = parseFloat($costAmountVal);
                                break;
                            default:
                                break;
                        }
                        $nArrs.push($objs);
                    }
                }
            }
            return $nArrs;
        }

        //监听提交
        form.on('submit(submit)', function(data) {
            if (!bizUtil.validator.verifyContainer($('form'))) {
                return false;
            }

            var $saveType = $(this).attr('id'),
                $saveText = '';

            //数据源
            var $saveData = {
                waybillId: $id,
                whRemark: data.field.whRemark,
                whHasCash: data.field.whCash == 'on' ? 1 : 0,
                trailerSettlementId: parseInt(data.field.trailerSettlementId) || null,
                prepaidFreight: parseFloat(data.field.prepaidFreight) || null
            };

            switch ($saveType) {
                case 'vsubmit': //暂存
                    $saveData.hasReceipt = false;
                    $saveText = '暂存';
                    break;
                case 'vreceipt': //回单
                    $saveData.hasReceipt = true;
                    $saveText = '回单';
                    if (!data.field.trailerSettlementId) {
                        layer.msg('请选择结算对象');
                        return false;
                    }
                    break;
                default:
                    break;
            }

            //应收费用
            if ($wrListArrs.length > 0) {
                $saveData.rrcList = [];
                var errorIds = [];
                var getAttrData = function(obj) {
                    var attrData = bizUtil.data.getAttrDataList(obj);
                    var newAttrData = [];
                    if (attrData.length > 0) {
                        $.each(attrData, function(k, v) {
                            if (!v.attFileUrl) {
                                errorIds.push(k);
                            }
                        });
                    }
                    if (errorIds.length == 0) {
                        newAttrData = attrData;
                    }
                    return newAttrData;
                }

                var freightTotal = 0; //应收运费总额
                //应收费用MAP
                var customerFreight = function(costArr, costName) {
                    var customerFreightMap = {};
                    if (costArr.length > 0) {
                        for (var j = 0; j < costArr.length; j++) {
                            customerFreightMap[costArr[j].recostName] = costArr[j].recostAmount;
                        }
                    }
                    return customerFreightMap[costName] || 0;
                }

                //循环多客户
                for (var i = 0; i < $wrListArrs.length; i++) {
                    var newObj = {};
                    var customerId = $wrListArrs[i][0].split('-')[2];
                    newObj.customerId = parseInt(customerId);
                    newObj.customerName = $('input[name="customerName' + customerId + '"]').val();
                    newObj.customerWaybillNo = $('input[name="customerWaybillNo' + customerId + '"]').val();
                    newObj.receivableCashFlag = ($('input[name="receivableCashFlag' + customerId + '"]:checked').val() == 'on') ? 1 : 0;
                    newObj.receivableCostRemark = $('textarea[name="receivableCostRemark' + customerId + '"]').val();
                    newObj.wrList = setDataArrs(1, $wrListArrs[i]) || null;

                    //计算多客户应收运费总额
                    freightTotal += customerFreight(newObj.wrList, '运费');

                    newObj.detailList = [];
                    var returnListAtts = {
                        returnListAtts: getAttrData($('.returnListAtts' + customerId))
                    };
                    var receiptListAtts = {
                        receiptListAtts: getAttrData($('.receiptListAtts' + customerId))
                    };
                    newObj.detailList.push(returnListAtts);
                    newObj.detailList.push(receiptListAtts);
                    $saveData.rrcList.push(newObj);
                }
                if (errorIds.length > 0) {
                    layer.msg('附件中有上传失败的文件，请重新上传或删除');
                    return false;
                }
            } else {
                $saveData.rrcList = null;
            }

            var submitData = function() {
                //应付费用
                $saveData.whList = setDataArrs(2, $whListArrs) || null;
                //车辆成本
                $saveData.wcList = setDataArrs(3, $wcListArrs) || null;

                // console.log($saveData);
                // console.log(JSON.stringify($saveData));
                // return false;

                //保存数据，调用接口
                $.ajax({
                    type: 'POST',
                    url: '/ucenter/tms/city/cityWaybill/receipt.shtml',
                    dataType: "json",
                    contentType: "application/json",
                    data: JSON.stringify($saveData),
                    success: function(d) {
                        var $code = d.code,
                            $msg = d.msg,
                            $objects = d.objects;

                        if ($code === 'SUCCESS') {
                            setLayerAlert(parent.layer, $saveText + '成功', {
                                yes: function() {
                                    //关闭窗口
                                    parent.layer.closeAll();

                                    //获取当前框架ID并刷新
                                    var $layId = $(window.parent.document).find('.layui-this').attr('lay-id');
                                    // parent['f' + $layId].location.reload();
                                    parent['f' + $layId].refreshTableList();
                                }
                            });
                        } else if ($code === 'ERROR_CITYWAYBILL_REPECIT') {
                            setLayerAlert(parent.layer, $msg);
                        } else if ($code === 'ERROR_TRAILERSETTLEMENTID_EMPTY') {
                            setLayerAlert(parent.layer, $msg);
                        } else {
                            setLayerAlert(parent.layer, $saveText + '失败');
                        }
                    }
                });
            }

            if (freightTotal != data.field.freight) {
                setLayerConfirm(parent.layer, '客户应收运费总和与下单应收运费不相等，确定要继续回单吗？', function() {
                    submitData();
                })
            } else {
                submitData();
            }

            return false;
        });

        //取消按钮
        $('#vclose').on('click', function() {
            parent.layer.closeAll();
        });
    });
</script>

</html>