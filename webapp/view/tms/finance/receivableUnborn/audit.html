<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>费用明细 - TMS</title>
    <link rel="stylesheet" href="/view/frame/layui/css/layui.css" media="all">
    <link rel="stylesheet" href="/view/frame/static/css/global.css?v=1.0">
    <style>
      body {margin:20px;}
      .layui-input-inline {padding-top: 10px;}
      .green {color:green;}
      .red {color:red;}
      span {color: #000; font-weight: bold;}
      .wrList {padding: 0 17px;}
      hr {margin: 0 10px; background: #b5b4b4;}
    </style>
  </head>
  <body>
    <form class="layui-form" autocomplete="off">
      <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
          <legend>应收费用</legend>
      </fieldset>

      <div class="layui-tab layui-tab-card">
        <ul class="layui-tab-title"></ul>
        <div class="layui-tab-content"></div>
      </div>

      <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
          <legend>应付费用</legend>
        </fieldset>
      <table class="layui-table" id="handleFreight" lay-size="sm">
        <colgroup>
            <col width="80">
            <col width="100">
            <col width="100">
            <col width="80">
            <col width="100">
            <col width="100">
            <col width="80">
            <col width="100">
            <col width="100">
            <col width="80">
            <col width="100">
            <col width="100">
        </colgroup>
        <thead>
            <tr>
                <th>序号</th>
                <th>费用</th>
                <th class="b">金额</th>
                <th>序号</th>
                <th>费用</th>
                <th class="b">金额</th>
                <th>序号</th>
                <th>费用</th>
                <th class="b">金额</th>
                <th>序号</th>
                <th>费用</th>
                <th>金额</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    

      <div class="layui-form-item">
        <div class="layui-inline">
          <label class="layui-form-label" style="width: 55px;padding-left: 17px;">现金结算</label>
          <div class="layui-input-inline">
            <span id="copeCashFlag"></span>
          </div>
        </div>
        <div class="layui-inline">
          <label class="layui-form-label" style="width: 56px;padding-left: 0;">预付车费</label>
          <div class="layui-input-inline">
            <span id="prepaidFreight"></span>
          </div>
        </div>
        <div class="layui-inline">
          <label class="layui-form-label" style="width: 56px;padding-left: 0;">应付备注</label>
          <div class="layui-input-inline">
            <span id="copeCostRemark"></span>
          </div>
        </div>
      </div>
      <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
        <legend>车辆成本</legend>
      </fieldset>
      <table class="layui-table" id="carFreight" lay-size="sm">
        <colgroup>
            <col width="80">
            <col width="100">
            <col width="100">
            <col width="80">
            <col width="100">
            <col width="100">
            <col width="80">
            <col width="100">
            <col width="100">
            <col width="80">
            <col width="100">
            <col width="100">
        </colgroup>
        <thead>
            <tr>
                <th>序号</th>
                <th>费用</th>
                <th class="b">金额</th>
                <th>序号</th>
                <th>费用</th>
                <th class="b">金额</th>
                <th>序号</th>
                <th>费用</th>
                <th class="b">金额</th>
                <th>序号</th>
                <th>费用</th>
                <th>金额</th>
            </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="layui-form-item">
        <div class="layui-inline">
          <label class="layui-form-label" style="width:55px;padding-left: 17px;">审核备注</label>
          <div class="layui-input-inline" style="width:1038px;">
            <textarea id="auditRemarks" name="auditRemarks" maxlength="1000" placeholder="" class="layui-textarea"></textarea>
          </div>          
        </div>
      </div>
      <br>
      <div class="layui-form-item" style="text-align:center;">
        <button class="layui-btn layui-btn-normal" lay-submit lay-filter="submit" style="width:150px;">审核</button>
        <button class="layui-btn layui-btn-primary btn-cancel" type="button" style="width:150px;">取消</button>
      </div>
    </form>
  </body>
  <script charset="utf-8" src="/view/frame/layui/layui.js"></script>
  <script charset="utf-8" src="/view/frame/static/js/jquery.min.js?v=1.0"></script>
  <script charset="utf-8" src="/view/tms/static/js/tms_index.js?v=1219"></script>
  <script charset="utf-8" src="/view/frame/static/js/layui.district.js?v=1.0"></script>
  <script charset="utf-8" src="/view/tms/static/js/tms_tab.js?v=1.0"></script>
  <script charset="utf-8" src="/view/frame/static/js/lang_zh_CN.js?v=1.0"></script>
  
  <script charset="utf-8" src="/view/frame/static/js/errorCodeMap.js"></script>
  <script charset="utf-8" src="/view/frame/static/js/HC.js?v=1.4"></script>
  <script charset="utf-8" src="/view/tms/static/js/validator.js"></script>
  <script charset="utf-8" src="/view/tms/static/js/bizUtil.js"></script>
  
  <script>
  layui.use(['form', 'layer', 'table', 'laydate', 'element'], function(){
    var form = layui.form,
        layer = layui.layer,
        table = layui.table,
        laydate = layui.laydate,
        tmsTab = layui.tms_tab,
        $ = layui.jquery,
        element = layui.element;

    //自定义验证规则
    form.verify({
      auditRemarks: function(value){
        if(value.length == 0){
          return '请输入审核备注';
        }
      }
    });

    var $targetId = $.trim(getUrlParam("targetId")),
        $waybillId = getUrlParam("waybillId") != "undefined" ? $.trim(getUrlParam("waybillId")) : "",
        $ordersId = getUrlParam("ordersId") != "undefined" ? $.trim(getUrlParam("ordersId")) : "",
        $jobNo = $.trim(getUrlParam("jobNo"));

    //调用接口
    $.ajax({
      type:"GET", 
      url:"/ucenter/general/finance/financeOrders/financeOrdersDetail.shtml?ordersType=1&status=0&targetId=" + $targetId + "&waybillId=" + $waybillId + "&jobNo=" + $jobNo + "&ordersId=" + $ordersId,
      dataType:"json",      
      contentType:"application/json",
      success:function(d){
        var $code = d.code,
            $msg = d.msg,
            $objects = d.objects;
           
        if($code === 'SUCCESS'){
          $("#receivableCashFlag").html($objects.receivableCashFlag == 0 ? "否" : "是");
          $("#receivableCostRemark").html($objects.receivableCostRemark);
          $("#copeCashFlag").html($objects.copeCashFlag == null ? '' : (($objects.copeCashFlag == 0)? "否" : "是"));
          $("#copeCostRemark").html($objects.copeCostRemark);
          $("#prepaidFreight").html($objects.prepaidFreight);

           // 应收费用
           var layuiTabTitle = $('.layui-tab .layui-tab-title'),
              layuiTabContent = $('.layui-tab .layui-tab-content');
            if ($objects.rrcList != null && $objects.rrcList.length > 0) {
                for (var i = 0; i < $objects.rrcList.length; i++) {
                    //添加多客户标签
                    layuiTabTitle.append('<li>' + $objects.rrcList[i].customerName + '</li>');
                    //添加多客户内容
                    layuiTabContent.append('<div class="layui-tab-item"></div>');
                    //默认第一个选中
                    if (i == 0) {
                        layuiTabTitle.find('li:first-child').addClass('layui-this');
                        layuiTabContent.find('.layui-tab-item:first-child').addClass('layui-show');
                    }
                    // 开始画客户内容表
                    var customerId = $objects.rrcList[i].customerId;
                        var receiveTableHtml = [
                            '<div id="reveiveTable', customerId, '">',
                            '<table class="layui-table" id="receiveFreight', customerId, '" lay-size="sm" style="margin:0;">',
                            '    <colgroup>',
                            // '        <col width="80">',
                            '        <col width="100">',
                            '        <col width="100">',
                            '        <col width="100">',
                            // '        <col width="80">',
                            '        <col width="100">',
                            '        <col width="100">',
                            '        <col width="100">',
                            // '        <col width="80">',
                            '        <col width="100">',
                            '        <col width="100">',
                            '        <col width="100">',
                            // '        <col width="80">',
                            '        <col width="100">',
                            '        <col width="100">',
                            '        <col width="100">',
                            '    </colgroup>',
                            '    <thead>',
                            '        <tr>',
                            '            <th>序号</th>',
                            '            <th>费用</th>',
                            '            <th>金额</th>',
                            // '            <th class="b">开发票</th>',
                            '            <th>序号</th>',
                            '            <th>费用</th>',
                            '            <th>金额</th>',
                            // '            <th class="b">开发票</th>',
                            '            <th>序号</th>',
                            '            <th>费用</th>',
                            '            <th>金额</th>',
                            // '            <th class="b">开发票</th>',
                            '            <th>序号</th>',
                            '            <th>费用</th>',
                            '            <th>金额</th>',
                            // '            <th>开发票</th>',
                            '        </tr>',
                            '    </thead>',
                            '    <tbody></tbody>',
                            '</table>',
                            '<div class="layui-row message-box">',
                            '    <div class="layui-col-sm3 layui-col-xs3">',
                            '        客户单号：<span name="customerWaybillNo', customerId, '"></span>',
                            '    </div>',
                            '    <div class="layui-col-sm3 layui-col-xs3">',
                            '        现金结算：<span name="receivableCashFlag', customerId, '"></span>',
                            '    </div>',
                            '    <div class="layui-col-sm6 layui-col-xs6">',
                            '        应收备注：<span name="receivableCostRemark', customerId, '"></span>',
                            '    </div>',
                            '</div>',
                            '</div>'
                        ].join('');
                        layuiTabContent.find('.layui-tab-item').eq(i).append(receiveTableHtml);
                          //应收费用客户单号、备注、现金结算
                        $('span[name="customerWaybillNo' + customerId + '"]').html($objects.rrcList[i].customerWaybillNo || '');
                        $('span[name="receivableCostRemark' + customerId + '"]').html($objects.rrcList[i].receivableCostRemark || '');
                        $('span[name="receivableCashFlag' + customerId + '"]').html(
                            $objects.rrcList[i].receivableCashFlag == null ? '' : (($objects.rrcList[i].receivableCashFlag == 1) ? '是' : '否')
                        );
                        //应收费用价格项
                        var $wrArrs = $objects.rrcList[i].wrList;
                        if ($wrArrs != null && $wrArrs.length > 0) {
                            setTableItem(1, '#receiveFreight' + customerId + ' tbody', 3, 4, $wrArrs);
                        }
                }
            }
          ($objects.whList != null) ? setTableItem(2, '#handleFreight tbody', 3, 4, $objects.whList): [];
          ($objects.wcList != null) ? setTableItem(3, '#carFreight tbody', 3, 4, $objects.wcList): [];
        }
      }
    });
     //画表（t：1应收，2应付，3车辆）（o：表格容器）（l：几列一组）（r：一行几组）（arrs：相对应数据组）
    // setTableItem(1, '#receiveFreight' + customerId + ' tbody', 3, 4, $wrArrs);
    function setTableItem(t, o, l, r, arrs) {
      //var $tableItems = getCostItem(t),
      var $tableItems = arrs,
          $html = '',
          className,
          $class = '';
      if ($tableItems.length > 0) {
          var hasCostTotal = 0;
          for (var $i = 0; $i < $tableItems.length; $i++) {
              var k = (hasCostTotal + 1) % r;
              $html += (k == 1) ? '<tr>' : '';
              var $rid, $wid, $name, $amount, $amount1, $hasInvoice;
              switch (t) {
                  case 1:
                      $rid = $tableItems[$i].id;
                      $wid = $tableItems[$i].recostItemId;
                      $name = $tableItems[$i].recostName;
                      $amount = $tableItems[$i].recostAmount == null ? 0: $tableItems[$i].recostAmount;
                      $hasInvoice = $tableItems[$i].hasInvoice == 1 ? 'checked' : '';
                      break;
                  case 2:
                      $rid = $tableItems[$i].id;
                      $wid = $tableItems[$i].hacostItemId;
                      $name = $tableItems[$i].hacostName;
                      $amount = $tableItems[$i].hacostAmount == null ? 0: $tableItems[$i].hacostAmount;
                      break;
                  case 3:
                      $rid = $tableItems[$i].id;
                      $wid = $tableItems[$i].carcostItemId;
                      $name = $tableItems[$i].carcostName;
                      $amount = $tableItems[$i].carcostAmount == null ? 0: $tableItems[$i].carcostAmount;
                      break;
                  default:
                      break;
              }
              className = '';
              if($amount > 0){
                className = "green";
              }else if($amount < 0){
                className = "red";
              }
              if (l == 4) {
                  $class = (k == 0) ? '' : 'class="b"';
                  $html += '<td>' + (hasCostTotal + 1) + '</td>' +
                      '<td>' + $name + '</td>' +
                      '<td class="amount">' + $amount + '</td>' +
                      '<td ' + $class + '><input type="checkbox" name="hasInvoice' + $wid + '" lay-skin="primary" ' + $hasInvoice + ' disabled></td>';
              } else if (l == 3) {
                  // $class = (k == 0) ? 'class="amount"' : 'class="b amount"';
                  $html += '<td>' + (hasCostTotal + 1) + '</td>' +
                      '<td>' + $name + '</td>' +
                      '<td class='+ className +'>'+ $amount  + '</td>';
              }
              $html += (k == 0 || (hasCostTotal + 1) == $tableItems.length) ? '</tr>' : '';
              hasCostTotal++;
              // }
              $(o).html($html);
          }

          //补缺少的单元格
          if (l == 4) form.render('checkbox');
          var $totalCol = Math.ceil(hasCostTotal / r); //总行数
          var $totalLen = $totalCol * r; //总列数
          var $d = $totalLen - hasCostTotal;
          var $sHtml = '';
          if ($d > 0) {
              for (var $n = 0; $n < $d; $n++) {
                  if (l == 4) {
                      $sHtml += ($n == $d - 1) ? '<td></td><td></td><td></td><td></td>' : '<td></td><td></td><td></td><td class="b"></td>';
                  } else if (l == 3) {
                      $sHtml += ($n == $d - 1) ? '<td></td><td></td><td></td>' : '<td></td><td></td><td class="b"></td>';
                  }
              }
              $(o).find('tr:last-child').append($sHtml);
          }
      }
    }

    //监听提交
    form.on('submit(submit)', function(data){
      var $auditRemarks = $.trim(data.field.auditRemarks);
      // var $lastChars = $auditRemarks.substr($auditRemarks.length - 1,1);
      // if($lastChars != "。"){
      //   $auditRemarks = $auditRemarks + "。";
      // }

      //数据源
      var $saveData = {
        status: 0,
        ordersType: 1,
        waybillId: $waybillId,
        auditRemarks: $auditRemarks
      }
      
      //调用接口
      $.ajax({
        type:"PUT", 
        url:"/ucenter/general/finance/financeOrders/financeOrdersAudit.shtml", 
        dataType:"json",      
        contentType:"application/json",               
        data:JSON.stringify($saveData),
        success:function(d){
          var $code = d.code,
              $msg = d.msg,
              $objects = d.objects;
             
          if($code === 'SUCCESS'){
            parent.layer.alert("审核成功", {
              closeBtn: 0,
              yes: function(index){
                parent.layer.closeAll();
                var layId = $(window.parent.document).find("li.layui-this").attr("lay-id");
                $(window.parent["f" + layId].document).find('.btn-search').click();
              }
            });
          }else{
            parent.layer.alert('保存信息失败，请重新填写！');
            return false;
          }
        }
      });
      return false;
    });

    $(".btn-cancel").on("click",function(){
      parent.layer.closeAll();
      return false;
    });
  });
  </script>
</html>